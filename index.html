<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DFPWM Stream Player (Auto-Reconnect + Stop)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    button { font-size: 1rem; padding: 0.5rem 1rem; margin: 0.3rem; }
    #status { margin: 1rem 0; }
    audio { display: none; }
  </style>
</head>
<body>
  <h1>DFPWM Stream Player</h1>
  <button id="start">Start Audio</button>
  <button id="stop" disabled>Stop Audio</button>
  <div id="status">Status: Idle</div>
  <audio id="player" controls playsinline></audio>

  <script>
    class DFPWMDecoder {
      constructor() {
        this.PREC = 10;
        this.POSTFILT = 140;
        this.fq = 0;
        this.q  = 0;
        this.s  = 0;
        this.lt = -128;
      }
      decode(data) {
        const { PREC, POSTFILT } = this;
        const out = new Float32Array(data.length * 8);
        let op = 0;
        for (let i = 0; i < data.length; i++) {
          let d = data[i];
          for (let b = 0; b < 8; b++, op++) {
            const t = (d & 1) ? 127 : -128;
            d >>= 1;
            const oldQ = this.q;
            let nq = this.q + (((this.s * (t - this.q)) + (1 << (PREC - 1))) >> PREC);
            if (nq === this.q && nq !== t) nq += (t === 127 ? 1 : -1);
            this.q = nq;
            const st = (t !== this.lt ? 0 : (1 << PREC) - 1);
            if (this.s !== st) this.s += (st ? 1 : -1);
            if (this.s < (1 << (PREC - 7))) this.s = (1 << (PREC - 7));
            let ov = (t !== this.lt ? ((nq + oldQ + 1) >> 1) : nq);
            this.fq += ((POSTFILT * (ov - this.fq) + 0x80) >> 8);
            out[op] = this.fq / 128;
            this.lt = t;
          }
        }
        return out;
      }
    }

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const decoder = new DFPWMDecoder();
    const audioEl = document.getElementById('player');
    let ws = null;
    let nextPlayTime = 0;
    let shouldReconnect = false;
    let reconnectDelay = 1000;

    function updateStatus(msg) {
      document.getElementById('status').textContent = 'Status: ' + msg;
    }

    async function startStreaming() {
      await audioCtx.resume();
      shouldReconnect = true;
      reconnectDelay = 1000;
      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
      // connect audio to player
      const dest = audioCtx.createMediaStreamDestination();
      audioEl.srcObject = dest.stream;
      audioEl.play().catch(()=>{});
      connect(dest);
    }

    function stopStreaming() {
      shouldReconnect = false;
      if (ws) ws.close();
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
      updateStatus('Stopped');
    }

    function connect(dest) {
      updateStatus('Connecting…');
      ws = new WebSocket('wss://cc-void-city-radio-piueq.ondigitalocean.app/ws');
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        updateStatus('Connected, streaming…');
        nextPlayTime = audioCtx.currentTime + 0.1;
      };
      ws.onmessage = evt => {
        const compressed = new Uint8Array(evt.data);
        const pcm = decoder.decode(compressed);
        const buffer = audioCtx.createBuffer(1, pcm.length, 48000);
        buffer.copyToChannel(pcm, 0);
        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        src.connect(dest);
        if (nextPlayTime < audioCtx.currentTime) {
          nextPlayTime = audioCtx.currentTime + 0.01;
        }
        src.start(nextPlayTime);
        nextPlayTime += buffer.duration;
      };
      ws.onerror = () => {
        ws.close();
      };
      ws.onclose = () => {
        if (!shouldReconnect) return;
        updateStatus('Disconnected, retrying in ' + (reconnectDelay/1000) + 's…');
        setTimeout(() => {
          reconnectDelay = Math.min(reconnectDelay * 2, 30000);
          connect(dest);
        }, reconnectDelay);
      };
    }

    document.getElementById('start').onclick = startStreaming;
    document.getElementById('stop').onclick = stopStreaming;
  </script>
</body>
</html>
