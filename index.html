<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>DFPWM WebSocket Audio Player</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }

    button {
      font-size: 1rem;
      padding: 0.5rem 1rem;
    }

    #status {
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <h1>DFPWM Stream Player (100 ms Chunks, 48 kHz)</h1>
  <button id="start">Start Audio</button>
  <div id="status">Status: Not connected</div>

  <script>
    class DFPWMDecoder {
      constructor() {
        this.PREC = 10;
        this.POSTFILT = 140;
        this.fq = 0;
        this.q = 0;
        this.s = 0;
        this.lt = -128;
      }

      decode(data) {
        const { PREC, POSTFILT } = this;
        const out = new Float32Array(data.length * 8);
        let op = 0;
        for (let i = 0; i < data.length; i++) {
          let d = data[i];
          for (let b = 0; b < 8; b++, op++) {
            const t = (d & 1) ? 127 : -128;
            d >>= 1;

            // Charge update
            const oldQ = this.q;
            let nq = this.q + (((this.s * (t - this.q)) + (1 << (PREC - 1))) >> PREC);
            if (nq === this.q && nq !== t) nq += (t === 127 ? 1 : -1);
            this.q = nq;

            // Strength update
            const st = (t !== this.lt ? 0 : (1 << PREC) - 1);
            if (this.s !== st) this.s += (st ? 1 : -1);
            if (this.s < (1 << (PREC - 7))) this.s = (1 << (PREC - 7));

            // Anti-jerk
            let ov = (t !== this.lt ? ((nq + oldQ + 1) >> 1) : nq);

            // Low-pass filter
            this.fq += ((POSTFILT * (ov - this.fq) + 0x80) >> 8);
            out[op] = this.fq / 128;
            this.lt = t;
          }
        }
        return out;
      }
    }

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    const decoder = new DFPWMDecoder();
    let nextPlayTime = 0;

    document.getElementById('start').onclick = async () => {
      await audioCtx.resume();
      const status = document.getElementById('status');
      status.textContent = 'Status: Connecting…';

      const ws = new WebSocket('wss://cc-void-city-radio-piueq.ondigitalocean.app/ws');
      ws.binaryType = 'arraybuffer';

      ws.onopen = () => {
        status.textContent = 'Status: Connected, streaming…';
        nextPlayTime = audioCtx.currentTime + 0.1;
      };
      ws.onerror = err => {
        console.error('WebSocket error', err);
        status.textContent = 'Status: WebSocket error';
      };
      ws.onclose = () => {
        status.textContent = 'Status: Connection closed';
      };

      ws.onmessage = evt => {
        const compressed = new Uint8Array(evt.data);
        const pcm = decoder.decode(compressed);

        // Tell the Web Audio API these samples are at 48 kHz
        const buffer = audioCtx.createBuffer(1, pcm.length, 48000);
        buffer.copyToChannel(pcm, 0);

        const src = audioCtx.createBufferSource();
        src.buffer = buffer;
        src.connect(audioCtx.destination);

        if (nextPlayTime < audioCtx.currentTime) {
          nextPlayTime = audioCtx.currentTime + 0.01;
        }

        src.start(nextPlayTime);
        nextPlayTime += buffer.duration;
      };
    };
  </script>
</body>

</html>